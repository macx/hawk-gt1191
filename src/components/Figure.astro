---
import type { ImageMetadata } from 'astro'
import { Image } from 'astro:assets'
import { markdown } from '@astropub/md'

/**
 * src: Expecting a imported image. For backward compatibility, imagePath is also supported.
 */
interface Props {
  src?: ImageMetadata | string
  imagePath?: string
  imageFormat?: string
  alt?: string
  caption?: string | boolean
  lazy?: boolean
  class?: string
}

const {
  src,
  imagePath,
  imageFormat,
  caption,
  alt,
  lazy = true,
  class: className
} = Astro.props as Props

// Einmalige, statische Abbildung aller Bilder in /src/images (wird von Vite zur Buildzeit ersetzt).
// Hinweis: Nur genutzt, wenn ein String-Pfad übergeben wurde. Für ImageMetadata entfällt dies komplett.
const IMAGE_MAP = import.meta.glob<{ default: ImageMetadata }>(
  '/src/images/**/*.{jpeg,jpg,png}'
)

// Auflösen der Quelle: bevorzugt src, dann (rückwärtskompatibel) imagePath
const passedPath = typeof src === 'string' ? src : imagePath

let imageMeta: ImageMetadata | undefined
if (src && typeof src === 'object') {
  // Direkte Übergabe eines importierten Bildes (empfohlen)
  imageMeta = src
} else if (passedPath) {
  if (IMAGE_MAP[passedPath]) {
    imageMeta = ((await IMAGE_MAP[passedPath]()) as { default: ImageMetadata })
      .default
  }
}
---

<figure class:list={['media-item', className]}>
  {
    imageMeta ? (
      <Image
        src={imageMeta}
        widths={[380, 670, 710]}
        sizes={`(max-width: 480px) 380px, (max-width: 800px) 670px, 710px`}
        format={imageFormat ?? 'webp'}
        alt={alt}
        loading={lazy ? 'lazy' : 'eager'}
      />
    ) : passedPath ? (
      <img
        src={passedPath}
        alt={alt}
        loading={lazy ? 'lazy' : 'eager'}
        style='max-width: 100%; height: auto; display: block; margin-inline: auto;'
      />
    ) : null
  }

  <slot />

  {
    caption && typeof caption === 'string' ? (
      <figcaption>{await markdown.inline(caption)}</figcaption>
    ) : null
  }
</figure>

<style is:global>
  /* Wende media-item Styles auf figure-Elemente an */
  figure.beoe,
  figure.media-item,
  figure:not([class]) {
    display: block;
    margin-block: 1lh var(--sp-content);
    background-color: var(--clr-bg-card);
    border-radius: var(--radius);
    border: 1px solid var(--clr-line);
    box-shadow: 0 0.53em 1em -0.5rem rgba(0, 0, 0, 0.15);
    margin-inline: calc(var(--sp) * -1);
    padding-block: var(--sp);
    padding-inline: var(--sp);
  }

  figure.beoe {
    img {
      margin-inline: auto;
    }
  }

  figure.media-item,
  figure:not([class]) {
    .expressive-code {
      margin-block-start: 0;
    }

    img {
      display: block;
    }

    img + .expressive-code {
      margin-block-start: var(--sp);
    }

    > figcaption {
      font-size: 0.8em;
      padding-block: 0.5em 1em;
      margin-block-end: 0;
    }

    &:has(> figcaption) {
      padding-block-end: var(--sp) 0;
    }

    > :is(.astro-code) {
      border: 0;

      & + :is(.astro-code, .snippet) {
        margin-block-start: var(--sp);
      }
    }
  }
</style>
